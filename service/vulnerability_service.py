from service.input_service import execute_command
from model.vulnerability import Vulnerability
from datetime import datetime
import os

vulnerabilities = []

def search_sensitive_log(data):       

    output = execute_command(f"adb logcat -d | grep {data} | tail -n 8")

    if output:
        print(f"[+] Sensitive data '{data}' were found in logs")        

        INSECURE_LOGGING_CWE = os.getenv("INSECURE_LOGGING_CWE")
        INSECURE_LOGGING_SEV = os.getenv("INSECURE_LOGGING_SEV")
        INSECURE_LOGGING_NAME = os.getenv("INSECURE_LOGGING_NAME")
        INSECURE_LOGGING_DESC = os.getenv("INSECURE_LOGGING_DESC")
        INSECURE_LOGGING_REFS = os.getenv("INSECURE_LOGGING_REFS")        
        INSECURE_LOGGING_REMEDIATION = os.getenv("INSECURE_LOGGING_REMEDIATION")

        vulnerability = Vulnerability(INSECURE_LOGGING_NAME, INSECURE_LOGGING_DESC, output, INSECURE_LOGGING_SEV, INSECURE_LOGGING_CWE, datetime.now(), INSECURE_LOGGING_REMEDIATION, INSECURE_LOGGING_REFS)

        vulnerabilities.append(vulnerability)

        print(f"[+] Vulnerability [{INSECURE_LOGGING_NAME}] Added")


def get_vulnerabilities():
    return vulnerabilities

def is_app_running(package):
    #check if app is running
    output = execute_command(f"adb shell ps | grep {package}")
    if package in output:
        return True
    return False

def check_root(package):
    is_rooted = is_rooted_device()

    if is_rooted:
        if not is_app_running(package):
            print("[-] App is not running")
            return

        filename = f"ui_dump_{datetime.now()}.xml"
        execute_command(f"adb shell uiautomator dump /sdcard/{filename}")
        output = execute_command("adb shell cat /sdcard/{filename} | grep root")

        if ("root" in output):
            print("[-] Root advise is being used")
            return
        
        ROOT_DETECTION_CWE = os.getenv("ROOT_DETECTION_CWE")
        ROOT_DETECTION_SEV = os.getenv("ROOT_DETECTION_SEV")
        ROOT_DETECTION_NAME = os.getenv("ROOT_DETECTION_NAME")
        ROOT_DETECTION_DESC = os.getenv("ROOT_DETECTION_DESC")
        ROOT_DETECTION_REFS = os.getenv("ROOT_DETECTION_REFS")        
        ROOT_DETECTION_REMEDIATION = os.getenv("ROOT_DETECTION_REMEDIATION")

        vulnerability = Vulnerability(ROOT_DETECTION_NAME, ROOT_DETECTION_DESC, output, ROOT_DETECTION_SEV, ROOT_DETECTION_CWE, datetime.now(), ROOT_DETECTION_REMEDIATION, ROOT_DETECTION_REFS)

        vulnerabilities.append(vulnerability)

        print(f"[+] Vulnerability [{ROOT_DETECTION_NAME}] Added")

def is_rooted_device():
    output = execute_command("adb shell whoami")
    print(f"[-] whoami: {output}")
    if "root" in output:
        return True
    return False